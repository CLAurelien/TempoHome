name: Deploy on Raspberry Pi (Main)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test SSH connection to Raspberry Pi
        id: sshcheck
        run: |
          echo "Testing SSH connectivity..."
          if ssh -o BatchMode=yes -o ConnectTimeout=5 aurel@192.168.1.27 "echo connected"; then
            echo "SSH OK"
          else
            echo "SSH failed"
            echo "ssh_failed=true" >> $GITHUB_ENV
          fi

      - name: Notify Discord if SSH failed
        if: env.ssh_failed == 'true'
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"ðŸš¨ TempoHome Main : impossible de se connecter en SSH au Raspberry Pi.\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
          exit 1

      - name: Test API Healthcheck
        if: env.ssh_failed != 'true'
        id: apicheck
        run: |
          echo "Testing API health endpoint..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://192.168.1.27:8000/health || echo 000)
          echo "API status code: $STATUS"
          if [[ "$STATUS" =~ ^(200|201|204)$ ]]; then
            echo "API healthy"
          else
            echo "API unhealthy"
            echo "api_unhealthy=true" >> $GITHUB_ENV
          fi

      - name: Notify Discord if API failed
        if: env.api_unhealthy == 'true'
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"ðŸš¨ TempoHome Main : l'API du Raspberry Pi ne rÃ©pond pas (Healthcheck HTTP Ã©chouÃ©).\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
          exit 1

      - name: Deploy code on Raspberry Pi
        if: env.ssh_failed != 'true' && env.api_unhealthy != 'true'
        run: |
          echo "Deploying stable code..."
          ssh aurel@192.168.1.27 "cd ~/TempoHome && git pull origin main && sudo systemctl restart tempo.service"

      - name: Notify Discord success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"ðŸŽ‰ DÃ©ploiement MAIN rÃ©ussi sur le Raspberry Pi !\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
